<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aqua-tan Smart Light 2.0</title>
    <link rel="stylesheet" href="pure.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="jqp_min.js"></script>
    <script language="javascript" type="text/javascript" src="jqp_cursor.js"></script>
    <script language="javascript" type="text/javascript" src="jqp_dragable.js"></script>
    <script language="javascript" type="text/javascript" src="jqp_dateAxisRenderer.js"></script>
    <link rel="stylesheet" type="text/css" href="jqp_min.css" />
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">
</head>

<body>
    <div class="p-m pure-menu-horizontal pure-menu-scrollable pm-fix">
        <a href="#" class="pure-menu-heading"><img width='32' height='32' title='' alt='' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IB2cksfwAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAAsTAAALEwEAmpwYAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgpMwidZAAABnklEQVRYCb2XUVLEMAxDW4b7X7mgwssorp2mtDQzYMeWJcW7fLBs27bo56VzEPp4SVgyEl9/o+77+SSZiAf3xYxEdCKeOib2+6yBSCYBCJX7AVv1HbuMDEDUDdhF/SjCTKzbWJ9W34FZInCwSnhaXEOjDUBEFD4KqnbrZBuQiIu6QFYX/oqxjj8z4IJZLhOVkQw/NBcNAFYkz0hVmzURcbo3bjegopo+gJE28N3341jqzHCPseNyAw7ESCbgOOVgY70TsmbHGf8KsiEGsh4GPDqOHA7z8ZNWG3CgSCDyOjl9MJkYPWZanDHQwBMJQpUJzLa+fwQUIYl6Z33wmhcWvNfJW3x6AxDzUu6KGCLuPd+Ag5/K4zY7cYn81wamH3BlA/E10yIj4JsbOKxfxqoNZOA7G8j49sVkGxA4EytJdqb613ButIHMRC2Td4biGsk2ANXpMMA/Rj1wqzYAp0z4JtyU18HHeIZZRxuIZE/f98ecbSCKnr0o4qt72+RVAxXhTL2JOvjMwJ0Xp4Iurvzud6ASqepRf1lf/Nf8IK7CF5KQSk/UTlbbAAAAAElFTkSuQmCC'></a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"><a href="#" class="pure-menu-link">Aqua-tan Smart Light 2.0</a></li>
        </ul>
    </div>

    <div class="l-content">

        <div class="a-t pure-g">

            <div id="led" class="pure-u-1 pure-u-md-1-3">
                <div class="at at-lighting">
                    <div class="at-header">
                        <h2>Light LED0</h2>

                        <span class="at-val">
                            <div id="ls0">--</div><span id="lv0">--</span>
                        </span>
                    </div>
                </div>
            </div>

        </div>

        <div id="settings">
            <div id="sec_sch" class="if pure-g">
                <div class="pure-u-1 pure-u-md-1-1">
                    <div class="l-box">
                        <h3 class="if-head">Auto lighting schedule</h3>
                        <p>
                            <form id="config" class="pure-form pure-form-stacked">
                                <fieldset id='fsets'>
                                    <legend>Scheduler</legend>
                                    <div class="pure-g">
                                        <div class="pure-u-1 pure-u-md-1-1">
                                            <input id="enable" value="1" type="checkbox"> Enable
                                        </div>
                                    </div>
                                    <legend>LED brightness graph</legend>
                                    <div class="pure-g">
                                        <div class="pure-u-1 pure-u-md-1-1">
                                            <div id="chart2" style="height: 300px; width: 1000px;"></div>
                                            <div id="chart1" style="height: 100px; width: 1000px;"></div>
                                        </div>
                                    </div>
                                   <!-- -->
                                    <button id="sch_sub" type="submit" class="pure-button pure-button-primary">Submit</button>
                                </fieldset>
                            </form>
                        </p>
                    </div>
                </div>
                <div class="pure-u-1 pureu-md-1-1">
                    <div class="l-box">
                        <button id="advbtn" type="button" class="button-adv pure-button">Advanced settings</button>
                    </div>
                </div>
                <div id="advanced-settings">
                    <div class="pure-u-1 pure-u-md-1-2">
                        <div class="l-box">
                            <h3 class="if-head">Reset WiFi settings</h3>
                            <p>Reset the WiFi AP setting by clicking this button.</p>
                            <p>
                                <form action="/wifireset" class="pure-form pure-form-stacked">
                                    <fieldset>
                                        <button type="submit" class="btn-red pure-button">Reset</button>
                                    </fieldset>
                                </form>
                            </p>
                        </div>
                    </div>

                    <div class="pure-u-1 pure-u-md-1-2">
                        <div class="l-box">
                            <h3 class="if-head">Reset ALL settings</h3>
                            <p>Reset the ALL setting by clicking this button.</p>
                            <p>
                                <form action="/reset" class="pure-form pure-form-stacked">
                                    <fieldset>
                                        <button type="submit" class="btn-red pure-button">Reset</button>
                                    </fieldset>
                                </form>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="pure-u-1 pureu-md-1-1">
                    &nbsp;
                </div>
            </div> <!-- end if -->
        </div> <!-- end setting -->
    </div> <!-- end l-content -->
    <div class="footer l-box">
        <p>
            Aqua-tan Smart Light 2.0 @omzn 2019
        </p>
    </div>
    <script type="text/javascript">
        var targetPlot, controllerPlot;

        var numberOfLEDs = 1;

        // make LED power form (this is a source of the graph)
        for (var jj = 0; jj < numberOfLEDs; jj++) {
            $('#fsets').append("<legend>LED" + jj.toString() + " values <button id='sbtn" + jj.toString() + "' type='button' class='button-show pure-button'>Show / Hide</button></legend>");
            $('#fsets').append("<div id='powerlist_" + jj.toString() + "'>");
            for (var j = 0; j < 24; j += 2) {
                var f2 = ('00' + j).slice(-2);
                var l2 = ('00' + (j + 1)).slice(-2);
                $('#powerlist_' + jj.toString()).append("<div id='v" + f2 + l2 + "' class='pure-g'></div>");
                $('#v' + f2 + l2).append("<div id='v" + f2 + "' class='pure-u-1 pure-u-md-1-2'></div>");
                $('#v' + f2 + l2).append("<div id='v" + l2 + "' class='pure-u-1 pure-u-md-1-2'></div>");
                $('#v' + f2).append("<div class='pure-u-1 pure-u-md-1-8'>" + f2 + ":</div>");
                $('#v' + l2).append("<div class='pure-u-1 pure-u-md-1-8'>" + l2 + ":</div>");
                for (var i = 0; i < 60; i += 10) {
                    $('#v' + f2).append("<div class='pure-u-1 pure-u-md-1-8'><input id='p" + jj.toString() + "_" + f2 + ('00' + i).slice(-2) + "' class='pure-u-22-24' type='text'></div>");
                    $('#v' + l2).append("<div class='pure-u-1 pure-u-md-1-8'><input id='p" + jj.toString() + "_" + l2 + ('00' + i).slice(-2) + "' class='pure-u-22-24' type='text'></div>");
                }
            }
            $('#powerlist_' + jj.toString()).hide();
            $('#sbtn' + jj.toString()).click(function () {
                $('#powerlist_' + jj.toString()).toggle();
            });
        }
        $('#advanced-settings').hide();

        $('#advbtn').click(function () {
            $('#advanced-settings').toggle();
        });

        $('form#config').submit(
            function (ev) {
                var query = "enable=" + $('#enable').prop('checked').toString();
                for (var jj = 0; jj < numberOfLEDs; jj++) {
                    for (var j = 0; j < 24; j++) {
                        for (var i = 0; i < 60; i += 10) {
                            var id = "p" + jj.toString() + "_" + ('00' + j).slice(-2) + ('00' + i).slice(-2);
                            query += "&" + id + "=" + $("#" + id).val();
                        }
                    }
                }
                $.post('/config', query, readconfig, "json");
                //$('#sch_sub').prop('disabled', true);
                return false;
            });

        function readconfig(json) {
            if (json.enable == "true") {
                $('#enable').prop("checked", true);
            } else {
                $('#enable').prop("checked", false);
            }
            var k = 0;
            for (var jj = 0; jj < numberOfLEDs; jj++) {
                for (var j = 0; j < 24; j++) {
                    for (var i = 0; i < 60; i += 10) {
                        var id = "#p" + jj.toString() + "_" + ('00' + j).slice(-2) + ('00' + i).slice(-2);
                        $(id).val(json.power[jj][k]);
                        k++;
                    }
                }
            }

            for (var key in json.power) {
                $("#" + key).val(json.power[key]);
            }
        }

        function update() {
            $.getJSON('/status', function (json) {
                if (json.status == 0) {
                    $('#ls0').html("OFF");
                } else if (json.status == 1) {
                    $('#ls0').html("ON");
                }
                $('#lv0').html(json.brightness.toString());
            });
        }

        function confset() {
            $.getJSON('/config', function (json) {
                readconfig(json);
                graph();
            });
        }

        $('#chart2').on('mouseup', function () {
            var k = 0;
            for (var jj = 0; jj < numberOfLEDs; jj++) {
                for (var j = 0; j < 24; j++) {
                    for (var i = 0; i < 60; i += 10) {
                        var date = ('00' + j).slice(-2) + ":" + ('00' + i).slice(-2);
                        var id = "#p" + jj.toString() + "_" + ('00' + j).slice(-2) + ('00' + i).slice(-2);
                        $(id).val(
                            Math.round(targetPlot.series[0].data[k][1]).toString()
                        );
                        controllerPlot.series[0].data[k][1] = targetPlot.series[0].data[k][1];
                        k++;
                    }
                }
            }
            controllerPlot.replot();
        });

        var lightpower = function () {
            var data = [[]];
            for (var jj = 0; jj < numberOfLEDs; jj++) {
                for (var j = 0; j < 24; j++) {
                    for (var i = 0; i < 60; i += 10) {
                        var date = ('00' + j).slice(-2) + ":" + ('00' + i).slice(-2);
                        var id = "#p" + jj.toString() + "_" + ('00' + j).slice(-2) + ('00' + i).slice(-2);
                        data[0].push([date, $(id).val()]);
                    }
                }
            }
            return data;
        };

        function graph1() {
            if (controllerPlot) {
                controllerPlot.destroy();
            }
            controllerPlot = $.jqplot("chart1",
                [],
                {
                    dataRenderer: lightpower,
                    seriesDefaults: {
                        showMarker: false,
                    },
                    axes: {
                        xaxis: {
                            renderer: $.jqplot.DateAxisRenderer,
                            tickOptions: {
                                formatString: '%H:%M',
                                tickInterval: "1 hour"
                            },
                        },
                        yaxis: {
                            min: 0,
                            max: 100,
                        }
                    },
                    cursor: {
                        show: true,
                        showTooltip: false,
                        zoom: true,
                        constrainZoomTo: 'x'
                    },
                    series: [
                        {
                            isDragable: false
                        }
                    ]

                }
            );
        }
        function graph2() {
            if (targetPlot) {
                targetPlot.destroy();
            }
            targetPlot = $.jqplot('chart2',
                [],
                {
                    dataRenderer: lightpower,
                    seriesDefaults: {
                    },
                    axes: {
                        yaxis: {
                            min: 0,
                            max: 100,
                            pad: 10,
                        },
                        xaxis: {
                            renderer: $.jqplot.DateAxisRenderer,
                            tickOptions: { formatString: '%H:%M' },
                            tickInterval: "1 hour"
                        }
                    },
                    cursor: {
                        show: true,
                        zoom: true,
                        showTooltip: false
                    },
                    series: [
                        {
                            dragable: {
                                color: 'red',
                                constrainTo: 'y'
                            },
                        }
                    ]
                }
            );
        }
        function graph() {
            graph1();
            graph2();
            $.jqplot.Cursor.zoomProxy(targetPlot, controllerPlot);
        }
        $(function () {

            $.jqplot.config.enablePlugins = true;
            $.jqplot._noToImageButton = true;

            confset();
            //graph();
            for (var jj = 0; jj < numberOfLEDs; jj++) {
                for (var j = 0; j < 24; j++) {
                    for (var i = 0; i < 60; i += 10) {
                        var id = "#p" + jj.toString() + "_" + ('00' + j).slice(-2) + ('00' + i).slice(-2);
                        $(id).change(function () {
                            if (Number($(this).val()) > 100) {
                                $(this).val("100");
                            } else if (Number($(this).val()) < 0) {
                                $(this).val("0");
                            }
                            graph();
                        });
                    }
                }
            }

            setInterval("update()", 1000);
        });

    </script>
</body>

</html>